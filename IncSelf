private static Map<String,String> getEnvValuesByNames(Set<String> developerNames) {
        Map<String,String> out = new Map<String,String>();
        if (developerNames == null || developerNames.isEmpty()) return out;
        for (Environment_Variables__mdt ev :
             [SELECT DeveloperName, Value__c
              FROM Environment_Variables__mdt
              WHERE DeveloperName IN :developerNames]) {
            out.put(ev.DeveloperName, ev.Value__c);
        }
        return out;
    }

    private static String formatDate(Date d) {
        if (d == null) return '';
        return Datetime.newInstance(d.year(), d.month(), d.day(), 0, 0, 0).format('dd/MM/yyyy');
    }
    private static String formatCurrency(Decimal v) {
        if (v == null) return '';
        return '$' + String.valueOf(v.setScale(2));
    }
    private static String sanitizeTitle(String inputStr) {
        if (inputStr == null || inputStr.trim() == '') return 'Record';
        String clean = inputStr.replaceAll('[\\\\/:*?"<>|#%&{}$!@`~^+=]', ' ');
        clean = clean.replaceAll('\\s+', '_');
        if (clean.length() > 120) clean = clean.substring(0, 120);
        return clean;
    }
}
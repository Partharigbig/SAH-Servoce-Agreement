@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    // Build wrapper using provided ContentVersion id and template name
    private static MC_OpportunityDocGen_Agreements.Wrapper buildWrapper(Id oppId, Id contentVersionId, String templateName) {
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ oppId };
        w.templateContentVersionId = contentVersionId;
        w.docTemplateName = templateName;
        return w;
    }

    @isTest static void testGenerateAgreement_HappyPath_UsingFactory() {
        Test.startTest();

        // Create Person Account + Opportunity via factory
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);

        // Create minimal product/pricebook/oli using factory helpers already in your TestDataFactory
        maica_cc__Support_Item__c supportItem = MC_TestDataFactory.CreateSupportItem();
        Product2 prod = MC_TestDataFactory.createProduct(null);
        PricebookEntry pbe = MC_TestDataFactory.createPricebookEntry(prod.Id);
        OpportunityLineItem oli = MC_TestDataFactory.createOpportunityLineItem(opp.Id, pbe.Id, supportItem.Id);

        // Create a Service Agreement record (minimal) and relate to Opportunity if class reads SA - safe fields only
        maica_cc__Service_Agreement__c sa = new maica_cc__Service_Agreement__c(
            Name = 'Test SA',
            Opportunity__c = opp.Id,
            maica_cc__Start_Date__c = Date.today(),
            maica_cc__End_Date__c = Date.today().addMonths(12),
            maica_cc__Funding_Source__c = 'Support at Home'
        );
        insert sa;

        // Use your TestDataFactory methods for DocumentTemplate + ContentVersion
        // createDocumentTemplateForAssessment takes a String docName and creates DocumentTemplate with CustomClassName=MC_DocumentGenerationClass
        String templateName = 'GeneralServiceAgreementTemplate';
        MC_TestDataFactory.createDocumentTemplateForAssessment(templateName);

        // createContentVersion returns a ContentVersion record (factory method exists)
        ContentVersion cv = MC_TestDataFactory.createContentVersion();

        // Build wrapper that passes CV id and template name to bypass ENV lookups
        MC_OpportunityDocGen_Agreements.Wrapper w = buildWrapper(opp.Id, cv.Id, templateName);

        // Call the invocable - should not throw
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            // If anything unexpected is thrown fail the test and show message
            System.assert(false, 'generateFromFlow threw unexpectedly: ' + ex.getMessage());
        }

        Test.stopTest();
    }

    @isTest static void testGenerateAgreement_NoRecordIds_ThrowsAuraHandledException() {
        Test.startTest();

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        // leave recordIds null/empty to trigger exception path

        Boolean sawExpected = false;
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            // original class throws AuraHandledException('No Opportunity Id provided.')
            String msg = ex.getMessage();
            System.debug('Exception message: ' + msg);
            // ensure message indicates missing opportunity id
            System.assert(msg != null && msg.toLowerCase().contains('opportunity id'), 'Unexpected exception message: ' + msg);
            sawExpected = true;
        }
        System.assert(sawExpected, 'Expected an exception when no Opportunity Id is provided.');

        Test.stopTest();
    }

    @isTest static void testGenerateAgreement_DeletedOpportunity_Throws() {
        Test.startTest();

        // Create account + opp then delete the opp to simulate "not found"
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);
        Id oppId = opp.Id;
        delete opp;

        // Ensure DocumentTemplate and ContentVersion exist via factory
        String templateName = 'GeneralServiceAgreementTemplate';
        MC_TestDataFactory.createDocumentTemplateForAssessment(templateName);
        ContentVersion cv = MC_TestDataFactory.createContentVersion();

        MC_OpportunityDocGen_Agreements.Wrapper w = buildWrapper(oppId, cv.Id, templateName);

        Boolean sawExpected = false;
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            // expected message: 'Opportunity not found for Id: <id>' (or similar)
            String msg = ex.getMessage();
            System.debug('Exception message: ' + msg);
            System.assert(msg != null && (msg.toLowerCase().contains('opportunity not found') || msg.toLowerCase().contains('not found')), 'Unexpected exception message: ' + msg);
            sawExpected = true;
        }
        System.assert(sawExpected, 'Expected an exception when Opportunity cannot be found.');

        Test.stopTest();
    }
}
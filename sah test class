@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    // small helper to create a DocumentTemplate + ContentVersion for tests
    private class TemplateBundle {
        public Id templateId;
        public Id contentVersionId;
        public String templateName;
    }

    private static TemplateBundle createTemplateAndCV(String name) {
        TemplateBundle tb = new TemplateBundle();
        DocumentTemplate dt = new DocumentTemplate(
            Name = name,
            IsActive = true,
            Type = 'MicrosoftWord',
            TokenMappingType = 'JSON'
        );
        insert dt;
        tb.templateId = dt.Id;
        tb.templateName = dt.Name;

        ContentVersion cv = new ContentVersion(
            Title = name + 'CV',
            PathOnClient = name + '.docx',
            VersionData = Blob.valueOf('dummy')
        );
        insert cv;
        tb.contentVersionId = cv.Id;
        return tb;
    }

    private static MC_OpportunityDocGen_Agreements.Wrapper makeWrapper(Id oppId, Id cvId, String templateName) {
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ oppId };
        w.templateContentVersionId = cvId;
        w.docTemplateName = templateName;
        return w;
    }

    @isTest static void testGenerateAgreement_HappyPath() {
        Test.startTest();

        // 1) create person account + opportunity via factory
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);

        // 2) product + pbe + oli via factory (createProduct expects supportCategoryId but accepts null in your factory)
        maica_cc__Support_Item__c supportItem = MC_TestDataFactory.CreateSupportItem();
        Product2 prod = MC_TestDataFactory.createProduct(null);
        PricebookEntry pbe = MC_TestDataFactory.createPricebookEntry(prod.Id);
        OpportunityLineItem oli = MC_TestDataFactory.createOpportunityLineItem(opp.Id, pbe.Id, supportItem.Id);

        // 3) Create Funding parent (minimal writable fields)
        maica_cc__Funding__c funding = new maica_cc__Funding__c(
            Name = 'TF Funding',
            maica_cc__Start_Date__c = Date.today(),
            maica_cc__End_Date__c = Date.today().addMonths(6),
            Funding_Type__c = 'Home Care Package'
        );
        insert funding;

        // 4) Create Funding Items (use only writeable fields)
        List<maica_cc__Funding_Item__c> fiList = new List<maica_cc__Funding_Item__c>{
            new maica_cc__Funding_Item__c(
                Name = 'FI AT Small',
                maica_cc__Budget_Type__c = 'Assistive technology',
                maica_cc__Approved_Amount__c = 300,
                maica_cc__Funding__c = funding.Id,
                maica_cc__Start_Date__c = Date.today()
            ),
            new maica_cc__Funding_Item__c(
                Name = 'FI HM Mid',
                maica_cc__Budget_Type__c = 'Home modification',
                maica_cc__Approved_Amount__c = 1500,
                maica_cc__Funding__c = funding.Id
            ),
            new maica_cc__Funding_Item__c(
                Name = 'FI Restorative',
                maica_cc__Budget_Type__c = 'Restorative care pathway',
                maica_cc__Approved_Amount__c = 5000,
                maica_cc__Funding__c = funding.Id
            )
        };
        insert fiList;

        // 5) Entitlements referencing funding items (only writeable fields)
        List<maica_cc__Entitlement__c> entList = new List<maica_cc__Entitlement__c>();
        for (Integer i = 0; i < fiList.size(); i++) {
            entList.add(new maica_cc__Entitlement__c(
                Name = 'Ent ' + i,
                maica_cc__Approved_Amount__c = 100 * (i + 1),
                maica_cc__Funding_Item__c = fiList[i].Id
            ));
        }
        insert entList;

        // 6) Approved services - minimal fields
        List<maica_cc__Approved_Service__c> asList = new List<maica_cc__Approved_Service__c>{
            new maica_cc__Approved_Service__c(Name='AS 1', maica_cc__Funding__c = funding.Id),
            new maica_cc__Approved_Service__c(Name='AS 2', maica_cc__Funding__c = funding.Id)
        };
        insert asList;

        // 7) Update opportunity to reference funding and funding source to exercise pickEnvKey path
        opp.Funding__c = funding.Id;
        opp.Funding_Source__c = 'Support at Home';
        update opp;

        // 8) Create a related person account to act as a related contact, then insert ContactContactRelation
        Account related = MC_TestDataFactory.createPersonAccount();
        ContactContactRelation ccr = new ContactContactRelation(
            ContactId = acc.PersonContactId,
            RelatedContactId = related.PersonContactId,
            Power_of_Attorney__c = true,
            Relationship__c = 'Child',
            Next_of_Kin__c = true
        );
        insert ccr;

        // 9) Create Service Agreement (minimal writable fields)
        maica_cc__Service_Agreement__c sa = new maica_cc__Service_Agreement__c(
            Name = 'SA Test',
            Opportunity__c = opp.Id,
            maica_cc__Start_Date__c = Date.today(),
            maica_cc__End_Date__c = Date.today().addMonths(12),
            maica_cc__Funding_Source__c = opp.Funding_Source__c
        );
        insert sa;

        // 10) Create template + CV and call the method
        TemplateBundle tb = createTemplateAndCV('GeneralServiceAgreementTemplate');
        MC_OpportunityDocGen_Agreements.Wrapper w = makeWrapper(opp.Id, tb.contentVersionId, tb.templateName);

        // method should execute without throwing
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception e) {
            System.assert(false, 'Unexpected exception on happy path: ' + e.getMessage());
        }

        Test.stopTest();
    }

    @isTest static void testGenerateAgreement_MissingId_Throws() {
        Test.startTest();
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
            System.assert(false, 'Expected exception for missing record id.');
        } catch (Exception ex) {
            System.assert(ex.getMessage().contains('No Opportunity Id'), 'Unexpected message: ' + ex.getMessage());
        }
        Test.stopTest();
    }

    @isTest static void testGenerateAgreement_DeletedOpportunity_Throws() {
        Test.startTest();
        Account a = MC_TestDataFactory.createPersonAccount();
        Opportunity o = MC_TestDataFactory.createOpportunity(a.Id);
        Id oid = o.Id;
        delete o; // remove the opportunity

        TemplateBundle tb = createTemplateAndCV('GeneralServiceAgreementTemplate_Missing');
        MC_OpportunityDocGen_Agreements.Wrapper w = makeWrapper(oid, tb.contentVersionId, tb.templateName);

        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
            System.assert(false, 'Expected exception when opportunity not found.');
        } catch (Exception ex) {
            System.assert(ex.getMessage().contains('Opportunity not found for Id'), 'Unexpected message: ' + ex.getMessage());
        }
        Test.stopTest();
    }
}
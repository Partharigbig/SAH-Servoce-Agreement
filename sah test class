@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    @testSetup
    static void setupTestData() {
        // create a person account and opportunity using factory
        Account person = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(person.Id);

        // create a ContentVersion (factory already provides one â€” but create explicitly to be clear)
        ContentVersion cv = MC_TestDataFactory.createContentVersion();

        // create the DocumentTemplate that the generator expects (default name used in class)
        DocumentTemplate dt = new DocumentTemplate(
            Name = 'GeneralServiceAgreementTemplate',
            IsActive = true,
            Type = 'MicrosoftWord',
            TokenMappingType = 'JSON'
        );
        insert dt;

        // store ids on static custom settings - not required; keeping minimal for test
        // The test methods will query items created above by their properties
    }

    // Happy path: call generateFromFlow with a real Opportunity Id and an explicit ContentVersion Id
    @isTest static void testGenerateAgreement_HappyPath() {
        // Fetch the person account and opp created in @testSetup
        Account acc = [SELECT Id, PersonContactId FROM Account WHERE PersonEmail = 'testSales@apex.com' LIMIT 1];
        Opportunity opp = [SELECT Id, AccountId FROM Opportunity WHERE AccountId = :acc.Id LIMIT 1];

        // Create a ContentVersion to pass directly to wrapper (ensure we have a current CV)
        ContentVersion cv = new ContentVersion(
            Title = 'SAH Template',
            PathOnClient = 'SAHTemplate.docx',
            VersionData = Blob.valueOf('Dummy content for test')
        );
        insert cv;

        // The wrapper accepts templateContentVersionId as ContentVersion.Id
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ opp.Id };
        w.templateContentVersionId = cv.Id;
        // docTemplateName omitted so class should resolve default template name
        // ensure the matching DocumentTemplate exists (created in @testSetup)

        Test.startTest();
            // Call the invocable. Should not throw and should complete mapping logic.
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        Test.stopTest();

        // No DGP inserted in test context due to Test.isRunningTest() guard inside class.
        // Assert no exceptions and basic sanity: the Opportunity must still exist
        Opportunity oppAfter = [SELECT Id FROM Opportunity WHERE Id = :opp.Id LIMIT 1];
        System.assertEquals(opp.Id, oppAfter.Id, 'Opportunity should remain unchanged after generation call.');
    }

    // Negative test: missing recordIds in wrapper -> expect AuraHandledException('No Opportunity Id provided.')
    @isTest static void testGenerateAgreement_NoRecordIds_Throws() {
        MC_OpportunityDocGen_Agreements.Wrapper wEmpty = new MC_OpportunityDocGen_Agreements.Wrapper();
        // intentionally leave wEmpty.recordIds null/empty

        Test.startTest();
            try {
                MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ wEmpty });
                // If we get here the test should fail
                System.assert(false, 'Expected AuraHandledException when no opportunity Id is provided.');
            } catch (Exception ex) {
                // The class throws AuraHandledException; assert the message contains our expected text.
                String msg = ex.getMessage();
                System.assert(msg != null && msg.contains('No Opportunity Id provided'), 'Expected "No Opportunity Id provided." but got: ' + msg);
            }
        Test.stopTest();
    }

    // Negative test: provided Id does not correspond to an Opportunity -> expect AuraHandledException('Opportunity not found for Id: ...')
    @isTest static void testGenerateAgreement_NonExistentOpportunity_Throws() {
        // Generate a fake (but well-formed) Id that won't match any Opportunity
        Id fakeOppId = Id.valueOf('006' + String.valueOf(Math.abs(Crypto.getRandomInteger()))); // 006... is Opportunity prefix

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ fakeOppId };

        Test.startTest();
            try {
                MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
                System.assert(false, 'Expected AuraHandledException when Opportunity is not found for provided Id.');
            } catch (Exception ex) {
                String msg = ex.getMessage();
                System.assert(msg != null && msg.contains('Opportunity not found for Id'), 'Expected Opportunity-not-found message but got: ' + msg);
            }
        Test.stopTest();
    }
}
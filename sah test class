@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    // helper to create a DocumentTemplate + ContentVersion
    private static Map<String, Id> createTemplateAndContent(String templateName) {
        Map<String, Id> out = new Map<String, Id>();

        // Create an active DocumentTemplate (mapping-only template)
        DocumentTemplate dt = new DocumentTemplate(
            Name = templateName,
            IsActive = true,
            Type = 'MicrosoftWord',
            TokenMappingType = 'JSON'
        );
        insert dt;
        out.put('templateId', dt.Id);

        // Create a simple ContentVersion (a docx blob)
        ContentVersion cv = new ContentVersion(
            Title = templateName + '_cv',
            PathOnClient = templateName + '.docx',
            VersionData = Blob.valueOf('dummy content for test')
        );
        insert cv;
        out.put('contentVersionId', cv.Id);

        return out;
    }

    private static MC_OpportunityDocGen_Agreements.Wrapper buildWrapper(Id oppId, Id contentVersionId, String templateName) {
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ oppId };
        // pass ContentVersionId directly to bypass ENV resolution
        w.templateContentVersionId = contentVersionId;
        // specify the mapping template name explicitly to avoid default/env lookup
        w.docTemplateName = templateName;
        return w;
    }

    @isTest static void testGenerateAgreement_HappyPath_MinimalSetup() {
        Test.startTest();

        // Use factory to create a Person Account and Opportunity
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);

        // Create a support item & product & pricebook entry and OLI using factory helpers
        maica_cc__Support_Item__c supportItem = MC_TestDataFactory.CreateSupportItem();
        Product2 prod = MC_TestDataFactory.createProduct(null);
        PricebookEntry pbe = MC_TestDataFactory.createPricebookEntry(prod.Id);
        OpportunityLineItem oli = MC_TestDataFactory.createOpportunityLineItem(opp.Id, pbe.Id, supportItem.Id);

        // Create a minimal Service Agreement tied to the Opportunity (the class will prefer SA tokens if present)
        maica_cc__Service_Agreement__c sa = new maica_cc__Service_Agreement__c(
            Name = 'Test SA',
            Opportunity__c = opp.Id,
            maica_cc__Start_Date__c = Date.today(),
            maica_cc__End_Date__c = Date.today().addMonths(12),
            maica_cc__Funding_Source__c = 'Support at Home'
        );
        insert sa;

        // Create DocumentTemplate + ContentVersion bundle
        String templateName = 'GeneralServiceAgreementTemplate';
        Map<String, Id> bundle = createTemplateAndContent(templateName);

        // Build wrapper and call the invocable
        MC_OpportunityDocGen_Agreements.Wrapper w = buildWrapper(opp.Id, bundle.get('contentVersionId'), templateName);

        // Ensure no exception is thrown for the happy path
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception e) {
            System.assert(false, 'generateFromFlow threw unexpectedly: ' + e.getMessage());
        }

        Test.stopTest();
    }

    @isTest static void testGenerateAgreement_MissingOpportunityId_Throws() {
        Test.startTest();

        // Build wrapper with no recordIds -> should throw the AuraHandledException path
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
            System.assert(false, 'Expected exception when no Opportunity Id provided.');
        } catch (Exception ex) {
            // error message was thrown in original class; assert it mentions No Opportunity Id
            System.assert(ex.getMessage().contains('No Opportunity Id'), 'Unexpected exception message: ' + ex.getMessage());
        }

        Test.stopTest();
    }

    @isTest static void testGenerateAgreement_DeletedOpportunity_Throws() {
        Test.startTest();

        // create account & opportunity then delete the opportunity to simulate "not found"
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);
        Id oppId = opp.Id;
        delete opp;

        // create template + cv
        String templateName = 'GeneralServiceAgreementTemplate';
        Map<String, Id> bundle = createTemplateAndContent(templateName);

        MC_OpportunityDocGen_Agreements.Wrapper w = buildWrapper(oppId, bundle.get('contentVersionId'), templateName);

        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
            System.assert(false, 'Expected exception when Opportunity was deleted.');
        } catch (Exception ex) {
            System.assert(ex.getMessage().contains('Opportunity not found for Id'), 'Unexpected exception message: ' + ex.getMessage());
        }

        Test.stopTest();
    }
}
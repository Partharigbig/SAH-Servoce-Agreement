@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    @testSetup
    static void setupCommonData() {
        // Use your factory to create baseline objects (person account + opp + product + oli etc.)
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);

        maica_cc__Support_Item__c supportItem = MC_TestDataFactory.CreateSupportItem();
        maica_cc__Support_Category__c supportCategory = MC_TestDataFactory.CreateSupportCategory();
        Product2 prod = MC_TestDataFactory.createProduct(supportCategory.Id);
        PricebookEntry pbe = MC_TestDataFactory.createPricebookEntry(prod.Id);
        OpportunityLineItem oli = MC_TestDataFactory.createOpportunityLineItem(opp.Id, pbe.Id, supportItem.Id);

        // Create a small Service Agreement record used by logic (some code paths read this)
        maica_cc__Service_Agreement__c sa = new maica_cc__Service_Agreement__c();
        sa.Name = 'Test SA Setup';
        sa.Opportunity__c = opp.Id;
        sa.maica_cc__Start_Date__c = Date.today();
        sa.maica_cc__End_Date__c = Date.today().addMonths(12);
        sa.maica_cc__Funding_Source__c = 'Support at Home';
        insert sa;

        // Create an active DocumentTemplate -- only set commonly writable fields.
        // Some orgs (packaged or different API versions) don't expose DeveloperName for DML in tests,
        // so we avoid setting it. If insert fails, we fall back to querying an existing template with same name.
        String tmplName = 'GeneralServiceAgreementTemplate';
        DocumentTemplate tmplToUse;
        try {
            DocumentTemplate tmpl = new DocumentTemplate();
            tmpl.Name = tmplName;
            tmpl.IsActive = true;
            tmpl.Type = 'MicrosoftWord';
            tmpl.TokenMappingType = 'JSON';
            tmpl.TokenMappingMethodType = 'CustomClass';
            // CustomClassName is optional but helps to match what production uses
            tmpl.CustomClassName = 'MC_OpportunityDocGen_Agreements';
            insert tmpl;
            tmplToUse = tmpl;
        } catch (DmlException dmx) {
            // fallback: find existing template with the name (if any)
            List<DocumentTemplate> found = [SELECT Id, Name FROM DocumentTemplate WHERE Name = :tmplName AND IsActive = true LIMIT 1];
            if (!found.isEmpty()) {
                tmplToUse = found[0];
            } else {
                // If none found, rethrow to surface real problem
                throw dmx;
            }
        }

        // Create a ContentVersion to act as templateContentVersionId
        ContentVersion cv = new ContentVersion();
        cv.Title = 'Test Agreement Template';
        cv.PathOnClient = 'AgreementTemplate.docx';
        cv.VersionData = Blob.valueOf('Test Content');
        insert cv;

        // minimal approved service / funding items are created by factory elsewhere; no return needed
    }

    // helper to fetch the opp created in @testSetup
    private static Opportunity getTestOpportunity() {
        return [SELECT Id, AccountId FROM Opportunity LIMIT 1];
    }

    private static ContentVersion getAnyContentVersion() {
        return [SELECT Id, ContentDocumentId FROM ContentVersion LIMIT 1];
    }

    private static String getTemplateName() {
        return 'GeneralServiceAgreementTemplate';
    }

    @isTest
    static void happyPath_test() {
        Test.startTest();
        Opportunity opp = getTestOpportunity();
        ContentVersion cv = getAnyContentVersion();

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ opp.Id };
        w.templateContentVersionId = cv.Id;
        w.docTemplateName = getTemplateName();

        // The implementation will not insert DocumentGenerationProcess under Test.isRunningTest()
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            System.assert(false, 'generateFromFlow threw unexpectedly in happyPath_test: ' + ex.getMessage());
        }
        Test.stopTest();
    }

    @isTest
    static void noId_throws() {
        Test.startTest();
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        // w.recordIds intentionally left null/empty

        Boolean sawExpected = false;
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            String msg = ex.getMessage() == null ? '' : ex.getMessage().toLowerCase();
            System.debug('noId_throws captured exception: ' + msg);
            // Expect the validation to complain about missing Id / Opportunity Id provided.
            System.assert(msg.contains('no opportunity') || msg.contains('no opportunity id') || msg.contains('no opportunity id provided') || msg.contains('no opportunity id'), 'Unexpected exception message: ' + msg);
            sawExpected = true;
        }
        System.assert(sawExpected, 'Expected an exception when wrapper has no recordIds.');
        Test.stopTest();
    }

    @isTest
    static void missingOpportunity_throws() {
        Test.startTest();
        // create+delete an opportunity to simulate missing record
        Account a = MC_TestDataFactory.createAccount();
        Opportunity tmpOpp = MC_TestDataFactory.createOpportunity(a.Id);
        Id missingOppId = tmpOpp.Id;
        delete tmpOpp; // remove it so generateFromFlow cannot find it

        ContentVersion cv = getAnyContentVersion();

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ missingOppId };
        w.templateContentVersionId = cv.Id;
        w.docTemplateName = getTemplateName();

        Boolean sawExpected = false;
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            String msg = ex.getMessage() == null ? '' : ex.getMessage().toLowerCase();
            System.debug('missingOpportunity_throws captured exception: ' + msg);
            System.assert(msg.contains('not found') || msg.contains('opportunity'), 'Unexpected exception message: ' + msg);
            sawExpected = true;
        }
        System.assert(sawExpected, 'Expected an exception when Opportunity cannot be found.');
        Test.stopTest();
    }
}
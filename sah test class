@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    // Helper to build a wrapper with a real ContentVersion Id and template
    private static MC_OpportunityDocGen_Agreements.Wrapper makeWrapperWithCV(Id recordId, Id contentVersionId, String templateName) {
        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ recordId };
        w.templateContentVersionId = contentVersionId;
        w.docTemplateName = templateName;
        return w;
    }

    @isTest static void testGenerateAgreement_HappyPath() {
        // Setup test data using MC_TestDataFactory
        Test.startTest();
        // Create a person Account (factory method creates and inserts)
        Account person = MC_TestDataFactory.createPersonAccount();
        // Create an Opportunity linked to that account
        Opportunity opp = MC_TestDataFactory.createOpportunity(person.Id);

        // Ensure we have a DocumentTemplate with the expected name (use same name class expects or override via wrapper)
        // The target class uses DEFAULT_TEMPLATE_NAME = 'GeneralServiceAgreementTemplate' by default.
        DocumentTemplate tmpl = new DocumentTemplate(
            Name = 'GeneralServiceAgreementTemplate',
            IsActive = true,
            Type = 'MicrosoftWord',
            TokenMappingType = 'JSON'
        );
        insert tmpl;

        // Create a ContentVersion to represent the DOCX to be merged; use factory if available else insert directly
        ContentVersion cv = new ContentVersion(
            Title = 'Test Agreement Template',
            PathOnClient = 'ServiceAgreement.docx',
            VersionData = Blob.valueOf('Dummy content for test')
        );
        insert cv;

        // Re-query to get the Id (ContentVersion.Id is returned on insert)
        ContentVersion cvq = [SELECT Id, ContentDocumentId FROM ContentVersion WHERE Id = :cv.Id LIMIT 1];

        // Build wrapper and call generate
        MC_OpportunityDocGen_Agreements.Wrapper w = makeWrapperWithCV(opp.Id, cvq.Id, 'GeneralServiceAgreementTemplate');

        // Call method - should not throw
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            // If any exception occurs, fail the test
            System.assert(false, 'Unexpected exception in happy path: ' + ex.getMessage());
        }
        Test.stopTest();

        // If we reached here, the run completed successfully.
        System.assert(true, 'Generate completed without exception.');
    }

    @isTest static void testGenerateAgreement_NonExistentOpportunity_Throws() {
        Test.startTest();
        // Create an Account + Opportunity then delete the opportunity to produce a valid Id that does not exist
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity tempOpp = MC_TestDataFactory.createOpportunity(acc.Id);
        Id validButMissingOppId = tempOpp.Id;
        // Delete to simulate "Id provided but record not found"
        delete tempOpp;

        // Create ContentVersion to satisfy the method (so it doesn't fall back to env vars)
        ContentVersion cv = new ContentVersion(
            Title = 'FakeTemplate',
            PathOnClient = 'Fake.docx',
            VersionData = Blob.valueOf('test')
        );
        insert cv;
        ContentVersion cvq = [SELECT Id FROM ContentVersion WHERE Id = :cv.Id LIMIT 1];

        MC_OpportunityDocGen_Agreements.Wrapper w = makeWrapperWithCV(validButMissingOppId, cvq.Id, 'GeneralServiceAgreementTemplate');

        // Expect AuraHandledException with message "Opportunity not found for Id: ..."
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
            System.assert(false, 'Expected AuraHandledException when Opportunity does not exist.');
        } catch (Exception ex) {
            // The class throws AuraHandledException('Opportunity not found for Id: ' + Id)
            String msg = ex.getMessage();
            System.assert(msg != null && msg.contains('Opportunity not found for Id'), 'Unexpected exception message: ' + msg);
        }
        Test.stopTest();
    }

    // Optional: test invalid input (no recordIds) -> AuraHandledException
    @isTest static void testGenerateAgreement_NoRecordIds_Throws() {
        Test.startTest();
        MC_OpportunityDocGen_Agreements.Wrapper emptyW = new MC_OpportunityDocGen_Agreements.Wrapper();
        // leave recordIds null to trigger guard at top of generateFromFlow
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ emptyW });
            System.assert(false, 'Expected AuraHandledException for missing Opportunity Id.');
        } catch (Exception ex) {
            System.assert(ex.getMessage().contains('No Opportunity Id provided.') || ex.getMessage().contains('No Opportunity Id'),
                          'Unexpected exception text when recordIds missing: ' + ex.getMessage());
        }
        Test.stopTest();
    }
}
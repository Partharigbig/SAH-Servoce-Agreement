@isTest
private class MC_OpportunityDocGen_Agreements_Test {

    @testSetup
    static void setupCommonData() {
        // create a person account and an opportunity to be reused by tests
        Account acc = MC_TestDataFactory.createPersonAccount();
        Opportunity opp = MC_TestDataFactory.createOpportunity(acc.Id);

        // create support item, product, pbe and oli using factory
        maica_cc__Support_Item__c supportItem = MC_TestDataFactory.CreateSupportItem();
        maica_cc__Support_Category__c supportCategory = MC_TestDataFactory.CreateSupportCategory();
        Product2 prod = MC_TestDataFactory.createProduct(supportCategory.Id);
        PricebookEntry pbe = MC_TestDataFactory.createPricebookEntry(prod.Id);
        OpportunityLineItem oli = MC_TestDataFactory.createOpportunityLineItem(opp.Id, pbe.Id, supportItem.Id);

        // Create a minimal Service Agreement (some code paths read this)
        maica_cc__Service_Agreement__c sa = new maica_cc__Service_Agreement__c();
        sa.Name = 'Test SA Setup';
        sa.Opportunity__c = opp.Id;
        sa.maica_cc__Start_Date__c = Date.today();
        sa.maica_cc__End_Date__c = Date.today().addMonths(12);
        sa.maica_cc__Funding_Source__c = 'Support at Home';
        insert sa;

        // Create an active DocumentTemplate with required fields.
        // Include DeveloperName (sometimes required in orgs) to avoid insert errors.
        DocumentTemplate tmpl = new DocumentTemplate();
        tmpl.Name = 'GeneralServiceAgreementTemplate';
        tmpl.DeveloperName = 'GeneralServiceAgreementTemplate';
        tmpl.IsActive = true;
        tmpl.Type = 'MicrosoftWord';
        tmpl.TokenMappingType = 'JSON';
        tmpl.TokenMappingMethodType = 'CustomClass';
        tmpl.CustomClassName = 'MC_OpportunityDocGen_Agreements'; // any existing class name is fine
        insert tmpl;

        // Create a ContentVersion to act as templateContentVersionId
        ContentVersion cv = new ContentVersion();
        cv.Title = 'Test Agreement Template';
        cv.PathOnClient = 'AgreementTemplate.docx';
        cv.VersionData = Blob.valueOf('Test Content');
        insert cv;
    }

    // helper to fetch the opp created in @testSetup
    private static Opportunity getTestOpportunity() {
        return [SELECT Id, AccountId FROM Opportunity LIMIT 1];
    }

    private static ContentVersion getAnyContentVersion() {
        return [SELECT Id, ContentDocumentId FROM ContentVersion LIMIT 1];
    }

    private static String getTemplateName() {
        // same as we inserted in @testSetup
        return 'GeneralServiceAgreementTemplate';
    }

    @isTest
    static void happyPath_test() {
        Test.startTest();
        Opportunity opp = getTestOpportunity();
        ContentVersion cv = getAnyContentVersion();

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ opp.Id };
        w.templateContentVersionId = cv.Id;
        w.docTemplateName = getTemplateName();

        // Should not throw; in test context the class will not insert DocumentGenerationProcess (it checks Test.isRunningTest())
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            // Fail with the exception message so we capture unexpected behavior
            System.assert(false, 'generateFromFlow threw unexpectedly in happyPath_test: ' + ex.getMessage());
        }
        Test.stopTest();
    }

    @isTest
    static void noId_throws() {
        Test.startTest();

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        // w.recordIds intentionally left null/empty to hit the validation that throws "No Opportunity Id provided."

        Boolean sawExpected = false;
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            String msg = ex.getMessage() == null ? '' : ex.getMessage().toLowerCase();
            System.debug('noId_throws captured exception: ' + msg);
            System.assert(msg.contains('opportunity') || msg.contains('id') || msg.contains('no'), 'Unexpected exception message: ' + msg);
            sawExpected = true;
        }
        System.assert(sawExpected, 'Expected an exception when wrapper has no recordIds.');
        Test.stopTest();
    }

    @isTest
    static void missingOpportunity_throws() {
        Test.startTest();
        // create+delete an opportunity to simulate missing record
        Account a = MC_TestDataFactory.createAccount();
        Opportunity tmpOpp = MC_TestDataFactory.createOpportunity(a.Id);
        Id missingOppId = tmpOpp.Id;
        delete tmpOpp; // remove it so generateFromFlow cannot find it

        ContentVersion cv = getAnyContentVersion();

        MC_OpportunityDocGen_Agreements.Wrapper w = new MC_OpportunityDocGen_Agreements.Wrapper();
        w.recordIds = new List<Id>{ missingOppId };
        w.templateContentVersionId = cv.Id;
        w.docTemplateName = getTemplateName();

        Boolean sawExpected = false;
        try {
            MC_OpportunityDocGen_Agreements.generateFromFlow(new List<MC_OpportunityDocGen_Agreements.Wrapper>{ w });
        } catch (Exception ex) {
            String msg = ex.getMessage() == null ? '' : ex.getMessage().toLowerCase();
            System.debug('missingOpportunity_throws captured exception: ' + msg);
            // class throws something like 'Opportunity not found for Id: ...' - check for 'not found' or 'opportunity' presence
            System.assert(msg.contains('not found') || msg.contains('opportunity'), 'Unexpected exception message: ' + msg);
            sawExpected = true;
        }
        System.assert(sawExpected, 'Expected an exception when Opportunity cannot be found.');
        Test.stopTest();
    }
}